<!doctype html>
<meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Main Tests</title>

<link href="../../tests/mainTests/helpers/styles.css" rel="stylesheet">

<!--[if lt IE 9]><script>document.documentElement.className+=' ie';</script><![endif]-->

<pre id="console"></pre>

<div class="group">
    <h1>Main Tests</h1>
    <p>These tests verify all aspects of the onfontready library itself, including graceful failures when improperly used. Please clear or disable your browser's cache prior to running these tests.</p>
</div>

<div class="group">
    <button id="startButton">Start Tests</button>

    <label>
        <input id="useLegacyCheckbox" type="checkbox" /> Use Legacy Version (required for IE6, IE7, & IE8)
    </label>
</div>

<div class="group">
    <h2>Results</h2>

    <table class="box">
        <tr>
            <td class="example f1">Font</td>
            <td class="description">
                <h4>Sanity Check</h4>
                <p>Uses normal font-loading capabilities. onfontready is not used. Susceptible to <a href="https://css-tricks.com/fout-foit-foft/">FOIT</a>.</p>
                <pre>Font: 'f1'</pre>
                <p><strong>Results:</strong> <em>Custom font should display</em></p>
            </td>
        </tr>
    </table>

    <table class="box">
        <tr>
            <td class="example f2">Font</td>
            <td class="description">
                <h4>Normal Usage</h4>
                <pre>Font: 'f2'</pre>
                <pre>Options: {}</pre>
                <p><strong>Results:</strong> <em>Custom font should display</em></p>
            </td>
        </tr>
    </table>

    <table class="box">
        <tr>
            <td class="example arial">Font</td>
            <td class="description">
                <h4>Known Font</h4>
                <pre>Font: 'Arial'</pre>
                <pre>Options: {}</pre>
                <p><strong>Results:</strong> <em>Arial font should display</em></p>
            </td>
        </tr>
    </table>

    <table class="box">
        <tr>
            <td class="example fantasy">Font</td>
            <td class="description">
                <h4>Generic Font-Family</h4>
                <p><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/font-family">Generic font families</a> can be specified in a font stack, but only without quotes. Specifying <span style="font-family: monospace;">{ generic: true }</span> causes onfontready to add the tested font without quotes in the CSS. Without this change, the generic font names are assumed to be the names of font faces that are loaded by the page.</p>
                <pre>Font: fantasy (generic)</pre>
                <pre>Options: { generic: true }</pre>
                <p><strong>Results:</strong> <em>Generic font-family fantasy should display</em></p>
            </td>
        </tr>
    </table>

    <table class="box">
        <tr>
            <td class="example cursive">Font</td>
            <td class="description">
                <h4>Generic Font-Family without Generic Option</h4>
                <p><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/font-family">Generic font families</a> cannot be detected properly if the generic option evaluates to false.</p>
                <pre>Font: cursive (generic)</pre>
                <pre>Options: { generic: false }</pre>
                <p style="color: #f33">Incorrect Usage: Always set the generic option to true when testing generic font families.</p>
                <p><strong>Results:</strong> <em>Fallback font (serif) should display, detection elements remain forever</em></p>
            </td>
        </tr>
    </table>

    <table class="box">
        <tr>
            <td class="example f3">Font</td>
            <td class="description">
                <h4>Using timeoutAfter and onTimeout</h4>
                <pre>Font: 'f3'</pre>
                <pre>Options: { timeoutAfter: 1, onTimeout: function() { ... } }</pre>
                <p><strong>Results:</strong> <em>Fallback font (serif) should display</em></p>
            </td>
        </tr>
    </table>

    <table class="box">
        <tr>
            <td class="example f4">Font</td>
            <td class="description">
                <h4>Zero timeoutAfter</h4>
                <p>Since <a href="https://developer.mozilla.org/en-US/docs/Glossary/Falsy">zero is falsy in JavaScript</a>, using a 0 timeoutAfter will effectively tell onfontready not to use a timeout at all.</p>
                <pre>Font: 'f4'</pre>
                <pre>Options: { timeoutAfter: 0, onTimeout: function() { ... } }</pre>
                <p style="color: #f33">Incorrect Usage: A 0 timeoutAfter is pointless. Use a negative timeoutAfter to do an <a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowTimers/setTimeout#Nested_timeouts_forced_to_>4ms">'immediate-ish' timeout</a>.</p>
                <p><strong>Results:</strong> <em>Custom font should display</em></p>
            </td>
        </tr>
    </table>

    <table class="box">
        <tr>
            <td class="example f9">Font</td>
            <td class="description">
                <h4>Negative timeoutAfter</h4>
                <p>Since <a href="https://developer.mozilla.org/en-US/docs/Glossary/Falsy">zero is falsy in JavaScript</a>, negative timeoutAfter values can be used for an <a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowTimers/setTimeout#Nested_timeouts_forced_to_>4ms">'immediate-ish' timeout</a>.</p>
                <pre>Font: 'f9'</pre>
                <pre>Options: { timeoutAfter: -1, onTimeout: function() { ... } }</pre>
                <p><strong>Results:</strong> <em>Fallback font (serif) should display</em></p>
            </td>
        </tr>
    </table>

    <table class="box">
        <tr>
            <td class="example f5">Font</td>
            <td class="description">
                <h4>Missing onTimeout</h4>
                <pre>Font: 'f5'</pre>
                <pre>Options: { timeoutAfter: 1 }</pre>
                <p style="color: #f33">Incorrect Usage: Always use onTimeout option if timeoutAfter option is used.</p>
                <p><strong>Results:</strong> <em>Fallback font (serif) should display</em></p>
            </td>
        </tr>
    </table>

    <table class="box">
        <tr>
            <td class="example f8">Font</td>
            <td class="description">
                <h4>Missing timeoutAfter</h4>
                <pre>Font: 'f8'</pre>
                <pre>Options: { onTimeout: function() { ... } }</pre>
                <p style="color: #f33">Incorrect Usage: Always use timeoutAfter option if onTimeout option is used.</p>
                <p><strong>Results:</strong> <em>Custom font should display</em></p>
            </td>
        </tr>
    </table>

    <table class="box">
        <tr>
            <td class="example f6">Font</td>
            <td class="description">
                <h4>Using sampleText</h4>
                <pre>Font: 'f6'</pre>
                <pre>Options: { sampleText: 'Hello World, onfontready' }</pre>
                <p><strong>Results:</strong> <em>Custom font should display</em></p>
            </td>
        </tr>
    </table>

    <table class="box">
        <tr>
            <td class="example f_Fo">Font</td>
            <td class="description">
                <h4>Using sampleText with Limited Font</h4>
                <p>Font 'f_Fo' only contains uppercase 'F' and lowercase 'o' glyphs. Since the sampleText only contains those characters, onfontready can detect that the custom font has been loaded.</p>
                <pre>Font: 'f_Fo'</pre>
                <pre>Options: { sampleText: 'oF' }</pre>
                <p><strong>Results:</strong> <em>Custom font should display only for 'F' and 'o' in 'Font'</em></p>
            </td>
        </tr>
    </table>

    <table class="box">
        <tr>
            <td class="example f_Yu">Font</td>
            <td class="description">
                <h4>Fully Unsupported Glyphs in sampleText False Negative</h4>
                <p>Font 'f_Yu' only contains uppercase 'Y' and lowercase 'u' glyphs. Since the sampleText doesn't contain those characters, onfontready cannot detect that the custom font has been loaded.</p>
                <pre>Font: 'f_Yu'</pre>
                <pre>Options: { sampleText: 'Hello World' }</pre>
                <p style="color: #f33">Incorrect Usage: If sampleText must be used, only use it with characters supported by the custom font being tested.</p>
                <p><strong>Results:</strong> <em>Fallback font (serif) should display, detection elements remain forever</em></p>
            </td>
        </tr>
    </table>

    <table class="box">
        <tr>
            <td class="example f7">Font</td>
            <td class="description">
                <h4>Partially Supported Glyphs in sampleText False Negative</h4>
                <p>Font 'f7' does not contain glyphs for uppercase 'Y', lowercase 'r', and lowercase 'u'. However it does contain the other glyphs in the sampleText. The unsupported glyphs will lead to differing widths in the sampleText, even after the custom font has loaded. onfontready cannot detect that the custom font has been loaded.</p>
                <pre>Font: 'f7'</pre>
                <pre>Options: { sampleText: 'Your Font' }</pre>
                <p style="color: #f33">Incorrect Usage: If sampleText must be used, only use it with characters supported by the custom font being tested.</p>
                <p><strong>Results:</strong> <em>Fallback font (serif) should display, detection elements remain forever</em></p>
            </td>
        </tr>
    </table>

    <table class="box">
        <tr>
            <td class="example f10">Font</td>
            <td class="description">
                <h4>sampleText with Character Width Equivalence False Positive</h4>
                <p>Many characters in Unicode can and do have the same width regardless of the font used. For example, consider the line-feed character is always zero-width. Many mathematical symbols and higher-level Unicode characters also have this same-width property, even if they visually appear different, in serif and monospace fonts. Since onfontready relies on differing widths of characters in different fonts, using such a width-equivalent character as the sampleText will cause onReady to be called immediately, even if the custom font isn't fully loaded. The custom font may load, but the false positive generated may allow the page to generate <a href="https://css-tricks.com/fout-foit-foft/">FOIT</a> text.</p>
                <pre>Font: 'f10'</pre>
                <pre>Options: { sampleText: '\n' }</pre>
                <p style="color: #f33">Incorrect Usage: If sampleText must be used, only use it with characters known to have different widths in serif and monospace.</p>
                <p><strong>Results:</strong> <em>Fallback font (serif) should display</em></p>
            </td>
        </tr>
    </table>

    <p>TODO: Add test for font containing no space character.</p>
    <p>TODO: Add test for icon font containing no space character.</p>
    <p>TODO: Add test for icon font with sampleText for icon replacement that equates to a width-equivalent character.</p>

    <table class="box">
        <tr>
            <td id="shutdownStateStatus" class="example shutdownStates">?</td>
            <td class="description">
                <h4>Shutdown States</h4>
                <p>Did the tests correctly shutdown, removing event listeners and DOM elements as expected?</p>
                <ul>
                    <li>IE6 will not use the fallback font for missing glyphs when a custom font has been loaded. Box glyphs will be used instead, which are always the same width, thus creating the potential for a false-positive onReady callback. There is no feasible fix, however, this is incorrect font usage anyway.</li>
                    <li>IE7 will always fall back to the serif font for missing glyphs when a custom font has been loaded. The serif values will always be the same width, thus creating the potential for a false-positive onReady callback. There is no feasible fix, however, this is incorrect font usage anyway.</li>
                </ul>
                <p>Runs on a 5 second timeout. False negatives are possible on slow connections.</p>
                <p><strong>Output</strong></p>
                <pre id="shutdownStateOutput">?</pre>
            </td>
        </tr>
    </table>
</div>

<script src="../../tests/mainTests/helpers/log.js"></script>
<script src="../../tests/mainTests/helpers/addFontFace.js"></script>
<script src="../../tests/mainTests/helpers/testRunner.js"></script>

<script src="../../tests/mainTests/builds/onfontready.legacy.js"></script>
<script>window.onfontreadyLegacy = window.onfontready;</script>
<script src="../../tests/mainTests/builds/onfontready.js"></script>

<script>
var startButton = document.getElementById('startButton');
var useLegacyCheckbox = document.getElementById('useLegacyCheckbox');
var shutdownStateStatus = document.getElementById('shutdownStateStatus');
var shutdownStateOutput = document.getElementById('shutdownStateOutput');

// Default IE 8 and below to using legacy version
if (document.documentElement.className.indexOf('ie') !== -1)
{
    useLegacyCheckbox.checked = true;
}

startButton.onclick = function() {
    startButton.setAttribute('disabled', 'disabled');

    if (useLegacyCheckbox.checked)
    {
        window.onfontready = window.onfontreadyLegacy;
    }

    window.testRunner(shutdownStateStatus, shutdownStateOutput);
};
</script>